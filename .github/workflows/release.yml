name: Build and Release Plugin

on:
  release:
    types: [published]

jobs:
  build:
    name: Build Plugin Package
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get release version
        id: get_version
        run: |
          # Extract version from tag (remove 'v' prefix if present)
          VERSION=${GITHUB_REF#refs/tags/}
          VERSION=${VERSION#v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Create plugin package
        run: |
          # Create temporary build directory
          mkdir -p build/myd-delivery-pro

          # Copy plugin files (excluding development files)
          rsync -av --progress ./ build/myd-delivery-pro/ \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='.gitignore' \
            --exclude='.claude' \
            --exclude='.DS_Store' \
            --exclude='node_modules' \
            --exclude='tests' \
            --exclude='docs' \
            --exclude='phpunit.xml.dist' \
            --exclude='composer.json' \
            --exclude='composer.lock' \
            --exclude='CLAUDE.md' \
            --exclude='TODO.md' \
            --exclude='REVIEW.md' \
            --exclude='FEATURE-EVOLUTION-API.md' \
            --exclude='IMPLEMENTATION-SUMMARY.md' \
            --exclude='api.http' \
            --exclude='build'

          # Create ZIP file
          cd build
          zip -r "../myd-delivery-pro-${{ steps.get_version.outputs.version }}.zip" myd-delivery-pro/
          cd ..

          # Verify ZIP was created
          if [ -f "myd-delivery-pro-${{ steps.get_version.outputs.version }}.zip" ]; then
            echo "âœ“ Plugin package created successfully"
            ls -lh "myd-delivery-pro-${{ steps.get_version.outputs.version }}.zip"
          else
            echo "âœ— Failed to create plugin package"
            exit 1
          fi

      - name: Upload Release Asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: ./myd-delivery-pro-${{ steps.get_version.outputs.version }}.zip
          asset_name: myd-delivery-pro-${{ steps.get_version.outputs.version }}.zip
          asset_content_type: application/zip

      - name: Success notification
        if: success()
        run: |
          echo "ðŸŽ‰ Plugin package built and uploaded successfully!"
          echo "Version: ${{ steps.get_version.outputs.version }}"
          echo "File: myd-delivery-pro-${{ steps.get_version.outputs.version }}.zip"
